# Jenkins Pipeline для Docker-деплоя приложения

Этот репозиторий содержит пример Jenkins Pipeline, который автоматизирует процесс деплоя Python-приложения с использованием Docker. Pipeline выполняется только при изменении файла `index.html`, и включает следующие шаги:

- **Очистка**: Удаление предыдущих Docker-контейнеров и образа (если существуют) для избежания конфликтов.
- **Сборка Docker-образа**: Построение нового образа с актуальным кодом.
- **Тестирование Docker-контейнера**: Запуск временного контейнера для проверки корректности запуска приложения.
- **Деплой Docker-контейнера**: Запуск контейнера с актуальной версией приложения на продакшн-порту.

## Структура проекта




## Jenkinsfile

### Основные этапы:

1. **Checkout**
   - **Описание:** Всегда клонируется репозиторий с ветки `main` из удалённого Git-репозитория.
   - **Цель:** Получить актуальную версию исходного кода, включая изменения в `index.html`.

2. **Cleanup (Очистка)**
   - **Условие выполнения:** Этап выполняется только при наличии изменений в файле `index.html` (директива `when { changeset ... }`).
   - **Шаги:**
     - Останавливает и удаляет тестовый контейнер `myapp-test`, если он существует.
     - Останавливает и удаляет продакшн-контейнер `myapp`, если он существует.
     - Удаляет предыдущий Docker-образ с тегом `myapp`.

3. **Build Docker Image (Сборка Docker-образа)**
   - **Условие выполнения:** Этап выполняется, если в изменённом коммите присутствует `index.html`.
   - **Шаг:** Собирается новый Docker-образ с тегом `myapp` с помощью команды:
     ```
     sudo docker build -t myapp .
     ```

4. **Test Docker Container (Тестирование Docker-контейнера)**
   - **Условие выполнения:** Этап выполняется, если в коммите изменён файл `index.html`.
   - **Шаги:**
     - Запускается временный контейнер `myapp-test` с пробросом порта `8001:8000` и командой:
       ```
       /bin/bash -c "python3 server.py"
       ```
     - Выполняется задержка, чтобы дать время приложению запуститься.
     - Тестовый контейнер останавливается и удаляется.

5. **Deploy Docker Container (Деплой Docker-контейнера)**
   - **Условие выполнения:** Этап выполняется, если в изменениях присутствует `index.html`.
   - **Шаги:**
     - Удаляются все предыдущие продакшн-контейнеры с именем `myapp`.
     - Запускается новый контейнер `myapp` с пробросом порта `8000:8000` и командой:
       ```
       /bin/bash -c "python3 server.py"
       ```
   - **Результат:** Обновлённое приложение развернуто и становится доступным на порту 8000.

## Параметры и настройки

- **Пользователь Jenkins и Docker:**  
  Для выполнения Docker-команд без ошибок, пользователь Jenkins должен иметь права доступа к Docker-сокету. Это может быть обеспечено добавлением пользователя Jenkins в группу `docker` или использованием `sudo` с соответствующими настройками в файле `/etc/sudoers.d/jenkins`.

- **Порт:**  
  Внутри контейнера приложение слушает на порту `8000`, который пробрасывается на порт `8000` хоста. В тестовой стадии используется порт `8001` для проверки, чтобы избежать конфликта.

- **Условное выполнение стадий:**  
  Используется директива `when { changeset pattern: 'index.html', comparator: 'ANT' }`, чтобы запускать этапы (Cleanup, Build, Test, Deploy) только при изменении файла `index.html`.

## Как использовать

1. **Настройка Jenkins:**  
   - Добавьте этот репозиторий в качестве Pipeline-проекта.
   - Убедитесь, что Jenkins-агент имеет доступ к Docker (через группу `docker` или настроенный `sudo`).

2. **Запуск Pipeline:**  
   - При каждом изменении файла `index.html` в репозитории Jenkins автоматически запустит весь процесс очистки, сборки, тестирования и деплоя.

3. **Доступ к приложению:**  
   - После успешного деплоя приложение будет доступно по адресу:  
     `http://<IP-адрес_хоста>:8000`

## Замечания

- Если Jenkins-агент является ephemeral (например, работает в Kubernetes или в Docker-контейнере), необходимо обеспечить, чтобы Docker-контейнер с приложением запускался на постоянном хосте.
- Обязательно убедитесь, что брандмауэр или настройки безопасности на хосте разрешают входящие подключения на порт 8000.

---

Таким образом, данный Pipeline обеспечивает автоматический деплой обновлённого приложения при изменении файла `index.html` с проверкой корректности работы через тестовую стадию и развертыванием свежей версии на Docker-хосте.
